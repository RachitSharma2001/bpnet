import bpnet
import bpnet.configurables
import bpnet.datasets
import bpnet.heads
import bpnet.layers
import bpnet.losses
import bpnet.metrics
import bpnet.models
import bpnet.seqmodel
import bpnet.trainers
import datasets_oncpu
import trainers_oncpu

# Macros:
# ==============================================================================
augment_interval = True
batchnorm = False
dataspec = 'dataspec.yml'
exclude_chr = ['chrX', 'chrY']
filters = 64
lambda = 10
lr = 0.004
n_bias_tracks = 0
n_dil_layers = 11
seq_width = 2500
tasks = ['rep1']
tconv_kernel_size = 25
test_chr = ['chr6', 'chr7', 'chr8']
tracks_per_task = 2
use_bias = False
valid_chr = ['chr5']

# Parameters for Adam:
# ==============================================================================
Adam.amsgrad = False
Adam.beta_1 = 0.9
Adam.beta_2 = 0.999
Adam.decay = 0.0
Adam.epsilon = None
Adam.lr = %lr

# Parameters for AddedChannels_StrandedProfile:
# ==============================================================================
AddedChannels_StrandedProfile.additional_bw_channels = \
    ['/share/quonlab/workspaces/ricsharma/data/bpp_100_f.bw',
     '/share/quonlab/workspaces/ricsharma/data/bpp_100_r.bw',
     '/share/quonlab/workspaces/ricsharma/data/bpp_250_f.bw',
     '/share/quonlab/workspaces/ricsharma/data/bpp_250_r.bw',
     '/share/quonlab/workspaces/ricsharma/data/bpp_500_f.bw',
     '/share/quonlab/workspaces/ricsharma/data/bpp_500_r.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/100_neg_gc_skew.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/25_neg_purine_skew.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/gc_content_25.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/gc_skew_50.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/NT2_RNAseq_rep2.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/100_neg_purine_skew.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/50_neg_gc_skew.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/gc_content_50.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/GeneAnnotations_neg.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/purine_skew_100.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/250_neg_gc_skew.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/50_neg_purine_skew.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/gc_skew_100.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/GeneAnnotations_pos.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/purine_skew_250.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/250_neg_purine_skew.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/gc_content_100.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/gc_skew_250.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/Methyl.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/purine_skew_25.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/25_neg_gc_skew.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/gc_content_250.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/gc_skew_25.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/NT2_RNAseq_rep1.bw',
     '/share/quonlab/workspaces/ricsharma/all_tracks/bigwig/purine_skew_50.bw']
AddedChannels_StrandedProfile.excl_chromosomes = None
AddedChannels_StrandedProfile.exclude_dna = True
AddedChannels_StrandedProfile.include_classes = False

# Parameters for ClassificationMetrics:
# ==============================================================================
# None.

# Parameters for DeConv1D:
# ==============================================================================
DeConv1D.batchnorm = %batchnorm
DeConv1D.filters = %filters
DeConv1D.n_hidden = 0
DeConv1D.n_tasks = %tracks_per_task
DeConv1D.padding = 'same'
DeConv1D.tconv_kernel_size = %tconv_kernel_size

# Parameters for DilatedConv1D:
# ==============================================================================
DilatedConv1D.add_pointwise = False
DilatedConv1D.batchnorm = %batchnorm
DilatedConv1D.conv1_kernel_size = 25
DilatedConv1D.filters = %filters
DilatedConv1D.n_dil_layers = %n_dil_layers
DilatedConv1D.padding = 'same'
DilatedConv1D.skip_type = 'residual'

# Parameters for GlobalAvgPoolFCN:
# ==============================================================================
GlobalAvgPoolFCN.batchnorm = %batchnorm
GlobalAvgPoolFCN.dropout = 0
GlobalAvgPoolFCN.dropout_hidden = 0
GlobalAvgPoolFCN.hidden = None
GlobalAvgPoolFCN.n_splines = 0
GlobalAvgPoolFCN.n_tasks = %tracks_per_task

# Parameters for IntervalAugmentor:
# ==============================================================================
# None.

# Parameters for MetricsOrderedDict:
# ==============================================================================
# None.

# Parameters for MovingAverages:
# ==============================================================================
MovingAverages.window_sizes = [1, 50]

# Parameters for multinomial_nll:
# ==============================================================================
# None.

# Parameters for my_bpnet_data:
# ==============================================================================
my_bpnet_data.augment_interval = %augment_interval
my_bpnet_data.dataspec = %dataspec
my_bpnet_data.exclude_chr = %exclude_chr
my_bpnet_data.include_metadata = False
my_bpnet_data.interval_augmentation_shift = 200
my_bpnet_data.intervals_file = None
my_bpnet_data.intervals_format = 'bed'
my_bpnet_data.peak_width = %seq_width
my_bpnet_data.seq_width = %seq_width
my_bpnet_data.shuffle = True
my_bpnet_data.tasks = %tasks
my_bpnet_data.test_chr = %test_chr
my_bpnet_data.track_transform = None
my_bpnet_data.valid_chr = %valid_chr

# Parameters for PeakPredictionProfileMetric:
# ==============================================================================
PeakPredictionProfileMetric.binsizes = [1, 10]
PeakPredictionProfileMetric.neg_max_threshold = 0.005
PeakPredictionProfileMetric.pos_min_threshold = 0.015
PeakPredictionProfileMetric.required_min_pos_counts = 2.5

# Parameters for ProfileHead:
# ==============================================================================
ProfileHead.activation = None
ProfileHead.bias_input = 'bias/{task}/profile'
ProfileHead.bias_net = @MovingAverages()
ProfileHead.bias_shape = (None, %n_bias_tracks)
ProfileHead.loss = @multinomial_nll
ProfileHead.loss_weight = 1
ProfileHead.metric = @PeakPredictionProfileMetric()
ProfileHead.net = @DeConv1D()
ProfileHead.postproc_fn = @softmax
ProfileHead.target_name = '{task}/profile'
ProfileHead.use_bias = %use_bias

# Parameters for RegressionMetrics:
# ==============================================================================
# None.

# Parameters for report_template:
# ==============================================================================
report_template.name = 'evaluate.ipynb'
report_template.raise_error = True

# Parameters for ScalarHead:
# ==============================================================================
ScalarHead.activation = None
ScalarHead.bias_input = 'bias/{task}/counts'
ScalarHead.bias_net = None
ScalarHead.bias_shape = (%n_bias_tracks,)
ScalarHead.loss = 'mse'
ScalarHead.loss_weight = %lambda
ScalarHead.metric = @RegressionMetrics()
ScalarHead.net = @GlobalAvgPoolFCN()
ScalarHead.postproc_fn = None
ScalarHead.target_name = '{task}/counts'
ScalarHead.use_bias = %use_bias

# Parameters for SeqModel:
# ==============================================================================
SeqModel.body = @DilatedConv1D()
SeqModel.heads = [@ProfileHead(), @ScalarHead()]
SeqModel.input_name = 'seq'
SeqModel.input_shape = (2500, 31)
SeqModel.optimizer = @keras.optimizers.Adam()
SeqModel.seqlen = %seq_width
SeqModel.tasks = %tasks

# Parameters for train:
# ==============================================================================
train.batch_size = 128
train.data = @my_bpnet_data()
train.early_stop_patience = 100
train.epochs = 1
train.eval_metric = None
train.eval_report = @report_template()
train.eval_skip = []
train.eval_train = False
train.model = @SeqModel()
train.seed = 1
train.stratified_sampler_p = None
train.tensorboard = True
train.train_batch_sampler = None
train.train_epoch_frac = 1.0
train.train_samples_per_epoch = None
train.trainer_cls = @CpuSeqModelTrainer
train.valid_epoch_frac = 1.0
train.validation_samples = None
